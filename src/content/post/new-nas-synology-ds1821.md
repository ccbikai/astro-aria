---
title: '白群晖：黑群晖用户的归宿'
description: '能花钱解决的问题就别折腾自己了。'
dateFormatted: 2022/07/20
author: Aozaki
---

## 黑群晖？白群晖？

这个问题要追溯到 4、5 年以前了。

当时用的台式机，机箱巨大，有硬盘笼，放几块硬盘不成问题。但是随着存储需求的上升，以及在外时间的增加，台式机这样需要关机或待机的设备显然不能再满足需求了。于是在朋友的撺掇下换了新机器，并且把旧机箱连带旧硬件挪到客厅里，安装了 Proxmox VE 以及 Windows Server、Openwrt，还有黑群晖等一众虚拟机。

再后来，我把旧机箱也清退了出去，换上了相对小巧的机箱（迎广 MS04）以及黑群晖社区最爱的华擎 J3455 ITX 主板。但在升级和维护的路上同样碰到了大量麻烦。同时，硬件性能的低下，以及运行时的噪声令我不堪其扰。

这几年用下来，折腾黑群晖尽管不用为群晖公司糟糕的硬件性能支付高额价格，但带来的问题是

1. 中塔机箱占地空间巨大
2. 硬件老化，并且不是服务器 / 嵌入式设备，极有可能无法耐受全天开机运行
3. 桌面设备再降频，也是非常非常耗电的
4. 清理、更换硬件不便
5. RAID 支持很糟糕
6. 虚拟机内的黑群晖无法读取 SMART 数据
7. 黑群晖版本通常无法跟上最新版

所以最后痛定思痛，上了白群晖。

## 选了什么型号的白群晖？

我最终的选择是 8 盘位的 DS1821+，官方价格大概在 8700 CNY 左右。

8 盘位，实际边上两条 NVMe SSD 插槽[也可以变成储存空间](https://www.chiphell.com/thread-2395056-1-1.html)，所以等于有 10 盘位。此外，DS1821+ 采用了 Ryzen V1500B 核心，4C8T，发热低，性能强，比在用的 J3455 甚至 J4125 都不知道强到哪里去了，唯一缺憾就是没有核显。

之前其实也考虑过最热销的 DS920+，官方价格 4000 出头。但是考虑到目前的硬盘使用情况（已经有 4 块 8T 硬盘运行中），以及将来的扩展性，加上 J4125 孱弱的性能实在不敢恭维，最后还是选择跳过了这个型号。双盘位的 DS720+ 自然也是直接略过了（尽管我真的考虑过两块 20T 硬盘插上用）。

随后是 DS1821+ 和六盘位兄弟 DS1621+ 之间的对决。官方价格上看，DS1621+ 的每 bay 价格为 7800 CNY / 6 = 1300 CNY/bay，而 DS1821+ 则为 8700 CNY / 8 = 1087.5 CNY/bay。DS1821+ 不仅较 DS1621+ 每盘位价格低，并且有着更多的盘位战未来。

由于群晖在淘宝、京东的价格非常坚挺，于是跑到咸鱼去店家。价格直接震惊了我，DS1821+ 甚至做了 900 CNY/bay 以下！代价是基本没有全国联保了。

考虑到 NAS 这种东西，一般不会跟显卡一样每年都想着要换，于是直接选择上 DS1821+ 战未来了…

## 硬盘选择？

由于 Chia 矿的暴毙，积压在矿老板和奸商手里的 HDD 面临着非常严重的去库存压力。而且由于 Chia 矿的特性，P 盘的时候非常耗 SSD，数据生成好后放入机械盘，只有极少量读取。所以矿盘基本可以认为是 95 新，放心大胆买就是了。

于是咸鱼物色了两块 16T 希捷银河 X16 作为新的成员。

SSD 方面，由于矿场 SSD 的工作状态不明，可能经受了高温和大量读写，所以目前不敢和从前一样去捡大船 SSD，只能利用手里库存内容了。

原先有一颗闲置的 SATA SSD，Intel S3610 1.6T，买的早，那会儿甚至还没清零盘的说法。加上 MLC 颗粒基本不用惮寿命问题，简直是下载盘的不二候选了。此次也是分配了 800G 作为下载空间，600G 作为 macOS TimeMachine 备份空间。

NVMe 插槽还是两个，查阅相关资料后决定加入一条闲置镁光 P2 1T 作为 Syncthing 等需要频繁同步、读写的文件使用。由于已经将频繁读写的文件与电影等内容分离，HDD 阵列并不需要太好的随机读写性能，因此不再加入 NVMe SSD 作为读缓存。

最终安排结果

- HDD：16T x 2 + 8T x 4 组成 SHR，48T 可用空间，16T 用于数据保护
- SSD：1.6T SATA + 1T NVMe，高速读写和虚拟机等足够使用

## 迁移与折腾

这次主要问题在于已有的 12.5T 数据迁移上。

之前 4 块 8T 硬盘组的是 JBOD，无法直接转换成 RAID / SHR，因此需要将数据迁移出后再迁移回来。于是在经历了一周的时间后，终于这 12.5T 数据顺利地导入了新的 SHR 阵列。

有几个踩坑点需要注意一下：

- 根据官方文档，SHR 阵列要求最好**从小盘开始添加**，所以这轮数据迁移是 8T JBOD ▶ 16T ▶ 8T SHR 的迁移过程。
- 今后更换硬盘，必须**大于等于现有硬盘**，并且建议从小盘开始更换。
- SHR 组建后需要有一个比较漫长的优化时间，可以看到后台对所有阵列内的盘进行长时间大量读写，此时**不能关机，也不能中断**，否则可能造成硬盘损坏。

SHR 本质是 RAID5，盘越多读写越快，我这里是 6 块硬盘组成的阵列，空盘最高速度达到了 900MB/s，从 SSD 下载盘移动数据时再也不用苦苦等候了。

## Docker 上跑了什么？

比起 VMM，我个人是更喜欢 Docker 运行容器，尽管存在系统更新麻烦（需要手动拉取更新镜像）的问题，但…由于我的环境并没有部署软路由，而群晖的 VMM 又无法便捷地从系统层面指定代理，于是能为 Container 添加代理的 Docker 依然是我最好的选择。

我跑了些什么

- Adguard
- alist
- aria2
- Clash
- Home Assistant（尚未完工）
- Portainer
- ss-rust（回家用）

### alist

这是个近期才发现的项目，支持度盘、夸克网盘、115 等一大票网盘的挂载，并且可以与 aria2 非常方便地联动。只要按照[官方教程](https://alist-doc.nn.ci/)走，差不多 3、5 分钟就完成了部署，打开后的界面可以直接往 aria2 导出下载，解决了困扰多年的网盘下载问题。

### ss-rust

在黑群晖时代我就已经试验过了一大票在外访问家庭内网的方案。

由于上海电信的政策，2019 年起便有大量反馈显示 DDNS 直接暴露路由器、Plex、群晖等也会被算作非法搭建网站而遭到中国电信的停用宽带处罚。加上直接暴露管理页面实际上也根本不安全，于是 DDNS 暴露管理端这个方案直接不再作考虑。

而类似 Zerotier、Tailscale 的虚拟内网方案，尽管优秀，但是国内 ISP 对 UDP 的强力 QoS 导致实际使用效果并不好。Tailscale 由于是基于 Wireguard 的，遭到 QoS 的情况稍微较 Zerotier 好一点点，因此我是作为备用方案，万一 ss-rust 容器崩溃或公网 IP 消失，还能打隧道回家看下什么情况。

群晖的 QuickConnect 由于需要重新在国内版本上实名制实用，加上以往的糟糕速度，直接不作考虑。

后续尝试过 snell 协议回家，表现优秀，但由于作者停更，于是更换为 ss-libev / ss-rust 使用。目前这一方案无混淆使用也是非常稳定，外面 iperf3 测试基本能跑满速度。

有几个改变点

- 映射到外网端口选择了高端口
- 加密选择了 `AES-128-GCM`
- 没有加入混淆，防止被误认为家中搭建有网站

## 下一步折腾计划

目前是已经将新到的白群晖相对充分地利用起来…并且由于性能的提升，整体的相应速度与处理速度较 J3455 黑群晖快了太多太多。

尚未解决的一个痛点是软路由翻墙问题。先前由于 Openwrt 和 OpenClash 作为主路由时各种不稳定，频繁导致全家断网，于是最终放弃了这个方案，恢复为设备各自翻墙、硬路由拨号。

但随之而来的问题就是上面提到的，类似群晖 VMM、HAOS 这样无法设置代理的设备 / 系统，没有软路由的话直接抓瞎。

也许可以考虑在 Docker 或 VMM 内起一个 Openwrt 作为旁路由使用，将需要代理的设备 / 系统的网关改过去，应该就能解决这些问题。

等有明确需求之后再考虑吧 🤣
